---
title: "Coronavirus Data Analysis for New York"
author: "Connor J Schweitzer"
---


```{r, echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```


```{r, include = FALSE}
require(ggplot2)
require(reshape2)
require(gganimate)
require(gifski)
require(readxl, quietly = TRUE)
require(xlsx, quietly = TRUE)
require(dplyr)
require(cowplot, quietly = TRUE)
require(googleway, quietly = TRUE)
require(ggrepel, quietly = TRUE)
require(ggspatial, quietly = TRUE)
require(libwgeom, quietly = TRUE)
require(sf, quietly = TRUE)
require(rnaturalearth, quietly = TRUE)
require(rnaturalearthdata, quietly = TRUE)
library(leaflet)
library(maps)
library(htmlwidgets)

setwd("C:\\Users\\CONNO\\OneDrive\\Documents\\GitHub\\COVID")

dat <- read_excel('USCOVID_TimeSeries.xlsx',sheet = 'covid')
dat.death <- read_excel('USCOVID_TimeSeries.xlsx',sheet = 'covid_deaths')

##Removes unnecessary fields
dat.death$iso2 <- NULL
dat.death$iso3 <- NULL
dat.death$code3 <- NULL
dat.death$FIPS <- NULL
dat.death$Country_Region <- NULL


dat$iso2 <- NULL
dat$iso3 <- NULL
dat$code3 <- NULL
dat$FIPS <- NULL
dat$Country_Region <- NULL 
#############################

##Tidies Data##
dat.melt <- melt(dat, id.vars = c('UID','Admin2','Province_State', 'Lat','Long_','Combined_Key'))
dat.melt$date <- dat.melt$variable
dat.melt$variable <- NULL
dat.melt$value <- as.numeric(dat.melt$value)
dat.melt$date <- as.Date(dat.melt$date,"%m/%d/%y") ##Sets date to date type

dat.death.melt <- melt(dat.death, id.vars = c('UID','Admin2','Province_State', 'Lat','Long_','Combined_Key','Population'))
dat.death.melt$date <- dat.death.melt$variable
dat.death.melt$variable <- NULL
dat.death.melt$value <- as.numeric(dat.death.melt$value)
dat.death.melt$date <- as.Date(dat.death.melt$date,"%m/%d/%y")


## NEW YORK ONLY ##
dat.melt.NY <- dat.melt[dat.melt$Province_State == 'New York',] 
dat.death.melt.NY <- dat.death.melt[dat.death.melt$Province_State == 'New York',] ##Removes all other States

##Long Island Only##
dat.melt.LI <- dat.melt.NY[dat.melt.NY$Admin2 == 'Suffolk' | dat.melt.NY$Admin2 == 'Nassau',]
dat.melt.LI <-dat.melt.LI[dat.melt.LI$value > 1,] ##Ignores early months
dat.death.melt.LI <- dat.death.melt.NY[dat.death.melt.NY$Admin2 == 'Suffolk' | dat.death.melt.NY$Admin2 == 'Nassau',]

##Downstate Only##
dat.melt.DS <- dat.melt.NY[dat.melt.NY$Admin2 == 'Suffolk' | dat.melt.NY$Admin2 == 'Nassau'|dat.melt.NY$Admin2 == 'New York'|dat.melt.NY$Admin2 == 'Westchester'|dat.melt.NY$Admin2 == 'Rockland'|dat.melt.NY$Admin2 == 'Orange',]

## DOWNSTATE ALL CASES ##
DSonly <-
  ggplot(dat.melt.DS, aes(x = date, y = value, color = Admin2, fill = Admin2))+
  geom_line(size = 1.5)+
  geom_point(size = 3)+
  geom_vline(data = NULL, xintercept = as.Date("3/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick4')+
  annotate('text', x = as.Date("3/20/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*9/10,label = 'NYS on Pause',
           color = 'firebrick4', fontface = c('bold'))+
  geom_vline(data = NULL, xintercept = as.Date("3/1/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick3')+
  annotate('text', x = as.Date("3/1/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*9/10,label = 'First Case in NY',
           color = 'firebrick3', fontface = c('bold'))+
  geom_vline(data = NULL, xintercept = as.Date("1/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick1')+
  annotate('text', x = as.Date("1/20/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*9/10,label = 'First case in US',
           color = 'firebrick1', fontface = c('bold'),hjust = -.05)+
  ylab('Count')+
  xlab('Date')+
  scale_y_continuous(label = scales::comma,
                     breaks = seq(from = 0, to = 200000, by = 5000),
                     expand = c(0,0))+
  scale_x_date(date_breaks = '14 days',
               date_labels = "%m/%d")+
  transition_reveal(date)+
  theme_bw()+
  theme(plot.title = element_text(hjust = .5),
        legend.title = element_blank(),
        legend.position = 'bottom')

dat.melt.DS.log <- dat.melt.DS
dat.melt.DS.log$value<- ifelse(dat.melt.DS$value == 0, .001,dat.melt.DS$value) ## Imputes small values so they plot

## DOWNSTATE LOG CASES ##
DSonlylog <-
  ggplot(dat.melt.DS.log, aes(x = date, y = value, color = Admin2, fill = Admin2))+
  geom_line(size = 1.5)+
  geom_point(size = 3)+
  geom_vline(data = NULL, xintercept = as.Date("3/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick4')+
  annotate('text', x = as.Date("3/20/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*7/10,label = 'NYS on Pause',
           color = 'firebrick4', fontface = c('bold'))+
  geom_vline(data = NULL, xintercept = as.Date("3/1/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick3')+
  annotate('text', x = as.Date("3/1/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*7/10,label = 'First Case in NY',
           color = 'firebrick3', fontface = c('bold'))+
  geom_vline(data = NULL, xintercept = as.Date("1/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick1')+
  annotate('text', x = as.Date("1/20/20",'%m/%d/%y'), y = max(dat.melt.DS$value)*7/10,label = 'First case in US',
           color = 'firebrick1', fontface = c('bold'),hjust = -.05)+
  ggtitle('Down State New York Log Cases')+
  ylab('Log(Count)')+
  xlab('Date')+
  transition_reveal(date)+
  scale_y_log10(expand = c(0,0))+
  scale_x_date(date_breaks = '14 days',
               date_labels = "%m/%d")+
  theme_bw()+
  theme(plot.title = element_text(hjust = .5),
        legend.title = element_blank(),
        legend.position = 'bottom')


## Adding Rate Growth to Downstate Data
RateGrowthDS <- dat.melt.DS %>%
  group_by(Admin2) %>%
  mutate(Diff_growth = value - lag(value),
         Rate_growth = Diff_growth/lag(value)*100)

RateGrowthDeath.LI <-
  dat.death.melt.LI %>%
  group_by(Admin2) %>%
  mutate(Diff_growth = value - lag(value),
         Rate_growth = Diff_growth/lag(value)*100)

RateGrowthDeath.LI <- RateGrowthDeath.LI[RateGrowthDeath.LI$value > 0,]


## 3-day moving average of rate growth
RateGrowthDS <- RateGrowthDS %>%
  group_by(Admin2) %>%
  mutate(Rate_growth_3day = (Rate_growth + lag(Rate_growth) + lag(Rate_growth,2))/3)

LongIsland <- c('Nassau', 'Suffolk')

RateGrowthDS <- filter(RateGrowthDS, value > 0 & Admin2 %in% LongIsland) ## Only Long Island 


RateGrowthDS$rg.lim <- ifelse(RateGrowthDS$Rate_growth> 100, 100, RateGrowthDS$Rate_growth) ## Growth Limited at 100 for Plotting Purposes

##STATIC CHART
LIOnlyRGstatic <-
  ggplot(RateGrowthDS, aes(x = date, y = rg.lim/100, fill = Admin2)) + geom_tile(aes(height = rg.lim/100, y = rg.lim/100/2, width = .9), alpha = .9, position='dodge')+
  scale_x_date(date_breaks = '3 days',
               date_labels = "%m/%d")+
  scale_y_continuous(label = scales::percent,
                     breaks = seq(from = 0, to = 10000, by = .1),
                     limits = c(0,1),
                     expand = c(0,0))+
  geom_vline(data = NULL, xintercept = as.Date("3/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick4')+
  facet_wrap(.~Admin2, ncol = 1)+
  annotate('text', x = as.Date("3/20/20",'%m/%d/%y'), y = .1,label = 'NYS on Pause',
           color = 'firebrick4', fontface = c('bold'))+
  labs(title='Day-by-day Confirmed Case Growth Rate -- Long Island Only') +
  ylab('% Increase in Confirmed Cases')+
  xlab('Date')+
  theme_minimal()+
  theme(plot.title = element_text(hjust = .5),
        legend.title = element_blank(),
        legend.position = 'bottom')


##Rate Growth Static -- Death##
LIonlyRGstaticdeath <-
  ggplot(RateGrowthDeath.LI, aes(x = date, y = Rate_growth/100, fill = Admin2, color = Admin2))+
  geom_bar(stat='identity', position = 'dodge')+
  scale_x_date(date_breaks = '3 days',
               date_labels = "%m/%d")+
  facet_wrap(.~Admin2, ncol = 1)+
  scale_y_continuous(label = scales::percent,
                     expand = c(0,0))+
  geom_vline(data = NULL, xintercept = as.Date("3/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick4')+
  annotate('text', x = as.Date("3/20/20",'%m/%d/%y'), y = 1.5,label = 'NYS on Pause',
           color = 'firebrick4', fontface = c('bold'))+
  labs(title='Day-by-day Death Growth Rate -- Long Island Only') +
  ylab('% Increase in Deaths')+
  xlab('Date')+
  theme_bw()+
  theme(plot.title = element_text(hjust = .5),
        legend.title = element_blank(),
        legend.position = 'bottom')

## 3-day moving average ##
LIonlyRG3day <- 
    ggplot(RateGrowthDS, aes(x = date, y = Rate_growth_3day/100, color = Admin2, fill = Admin2))+
      geom_point(aes(x = date, y = Rate_growth/100, color = Admin2, fill = Admin2),alpha = .5)+
      geom_line(size = 1.5)+
      geom_vline(data = NULL, xintercept = as.Date("3/20/20",'%m/%d/%y'),linetype = 'dashed', color = 'firebrick4')+
      scale_x_date(date_breaks = '3 days',
                   date_labels = "%m/%d")+
      scale_y_continuous(label = scales::percent,
                         expand = c(0,0))+
      annotate('text', x = as.Date("3/20/20",'%m/%d/%y'), y = 1.5,label = 'NYS on Pause',
               color = 'firebrick4', fontface = c('bold'))+
      labs(title='3-Day Moving Average Confirmed Cases -- Long Island Only') +
      ylab('% Increase in Cases - 3 day average')+
      xlab('Date')+
      theme_bw()+
      theme(plot.title = element_text(hjust = .5),
            legend.title = element_blank(),
            legend.position = 'bottom')
```

## Downstate New York

New York City cases have well outpaced the rest of downstate New York:

```{r, echo=FALSE}
suppressWarnings(animate(DSonly, nframes = 100, renderer = gifski_renderer("Downstate.gif")))
```

The NYS on Pause measure appears to have been effective at slowing the growth rate of the virus, illustrated by a bending curve when viewing the same data on a log scale. 

```{r, echo=FALSE}

suppressWarnings(animate(DSonlylog, nframes = 100, renderer = gifski_renderer("DownstateLog.gif")))

```

## Long Island 

Long Island experienced early exponential growth, which was significantly slowed by the NYS on Pause orders. 

```{r, echo = FALSE}

suppressWarnings(plot(LIOnlyRGstatic))

```

The growth have death rates have experienced a similar decline.

```{r, echo = FALSE}

suppressWarnings(plot(LIonlyRGstaticdeath))

```

The 3-day moving average illustrates a clear decline in growth of cases, though missing values (from delayed data reporting) were not imputed or smoothed. 

```{r, echo = FALSE}

suppressWarnings(plot(LIonlyRG3day))

```

